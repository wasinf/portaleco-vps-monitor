<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infra Dashboard - VPS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #edf4ff;
      --card: #f8fbff;
      --ink: #152a44;
      --muted: #5a7596;
      --accent: #1f6fca;
      --ok: #2f7f5d;
      --warn: #b58a2f;
      --bad: #aa4e4e;
      --line: #d7e6f7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(42, 111, 203, 0.22), transparent 60%),
        radial-gradient(900px 420px at 100% 0%, rgba(22, 94, 164, 0.16), transparent 62%),
        linear-gradient(180deg, #f3f8ff, var(--bg));
      color: var(--ink);
      padding: 34px 28px;
      min-height: 100vh;
    }

    .auth-shell {
      max-width: 420px;
      margin: 8vh auto 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.97), rgba(247,252,255,0.97));
      border: 1px solid #cfe3fa;
      border-radius: 20px;
      box-shadow: 0 22px 50px rgba(17, 58, 106, 0.18);
      padding: 20px;
      backdrop-filter: blur(4px);
      position: relative;
      overflow: hidden;
    }

    .auth-shell::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 5px;
      background: linear-gradient(90deg, #1a6cc9, #2d8ae2, #1f6fca);
    }

    .auth-shell h2 {
      margin: 0;
      font-size: 30px;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }

    .auth-kicker {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #2f6fb6;
      margin: 6px 0 8px;
    }

    .auth-subtitle {
      margin: 2px 0 10px;
      color: #44678f;
      font-size: 13px;
      line-height: 1.35;
    }

    .auth-msg {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 12px;
      min-height: 18px;
    }

    .auth-msg.is-error {
      color: #9b2c2c;
      font-weight: 600;
    }

    .auth-msg.is-ok {
      color: #1f5f46;
      font-weight: 600;
    }

    .auth-label {
      display: block;
      font-weight: 600;
      margin: 10px 0 6px;
      font-size: 14px;
    }

    .auth-input {
      width: 100%;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--ink);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .auth-input:focus {
      outline: none;
      border-color: #67a0dd;
      box-shadow: 0 0 0 3px rgba(31, 111, 202, 0.16);
      background: #fbfdff;
    }

    .auth-input:-webkit-autofill,
    .auth-input:-webkit-autofill:hover,
    .auth-input:-webkit-autofill:focus,
    .users-field input:-webkit-autofill,
    .users-field input:-webkit-autofill:hover,
    .users-field input:-webkit-autofill:focus {
      -webkit-text-fill-color: var(--ink);
      box-shadow: 0 0 0 1000px #fff inset;
      transition: background-color 9999s ease-out 0s;
      border: 1px solid var(--line);
    }

    .pw-wrap {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .pw-toggle {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 10px;
      height: 40px;
      width: 44px;
      min-width: 44px;
      padding: 0;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .pw-toggle svg {
      width: 18px;
      height: 18px;
      stroke: #2a4d75;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .pw-toggle:hover {
      background: #f3f8ff;
    }

    .field-help {
      margin-top: 5px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .caps-warning {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 700;
      color: #9b2c2c;
      display: none;
    }

    .caps-warning.open {
      display: block;
    }

    .auth-btn {
      margin-top: 14px;
      width: 100%;
      border: 1px solid #0f4f99;
      background: #1f6fca;
      color: #fff;
      border-radius: 10px;
      padding: 11px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.18s ease, filter 0.18s ease;
      box-shadow: 0 10px 20px rgba(31, 111, 202, 0.22);
    }

    .auth-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .auth-btn:active {
      transform: translateY(0);
    }

    .auth-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
    }

    .session-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .session-user {
      display: inline-flex;
      align-items: center;
      min-height: 38px;
      color: var(--muted);
      font-size: 13px;
    }

    .logout-btn {
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      padding: 0 14px;
      cursor: pointer;
    }

    .gear-btn {
      width: 38px;
      height: 38px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
    }

    .users-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 42, 68, 0.42);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 40;
    }

    .users-modal.open {
      display: flex;
    }

    .users-panel {
      width: min(980px, 100%);
      max-height: calc(100vh - 48px);
      overflow: auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15);
      padding: 14px;
    }

    .users-panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .users-panel-head h2 {
      margin: 0;
      font-size: 24px;
    }

    .users-toolbar {
      display: flex;
      gap: 8px;
      align-items: end;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .users-field {
      display: grid;
      gap: 4px;
      min-width: 180px;
      flex: 1;
    }

    .users-field label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    .users-field input,
    .users-field select {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background: #fff;
      color: var(--ink);
    }

    .users-field .pw-wrap .auth-input {
      border-radius: 8px;
      height: 38px;
      padding: 8px 10px;
    }

    .users-field .pw-wrap .pw-toggle {
      height: 38px;
      border-radius: 8px;
      min-width: 72px;
    }

    .primary-btn {
      border: 1px solid #0f4f99;
      background: #1f6fca;
      color: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }

    .mini-btn {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .top-stack {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 12px;
      width: 100%;	
    }

    .top-stack > .hero,
    .top-stack > .card {
      grid-column: 1 / -1;
      width: 100%;
      max-width: none;
      margin: 0;
      justify-self: stretch;
     }

    .hero {
      border-radius: 18px;
      padding: 18px;
      background:
        linear-gradient(135deg, rgba(13,79,153,0.18), rgba(31,111,202,0.16)),
        url("/img/hero-infra.png") center center/cover no-repeat;
      color: #fff;
      box-shadow: 0 14px 30px rgba(0,0,0,0.12);
      min-height: 260px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
    }

    .hero h1 {
      margin: 0 0 6px;
      font-size: 68px;
      line-height: 1.02;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    .hero p {
      margin: 0;
      opacity: 0.98;
      font-size: 30px;
      line-height: 1.15;
      max-width: 900px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }

    .card {
      grid-column: span 6;
      border-radius: 16px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      min-width: 0;
    }

    .card.full { grid-column: span 12; }

    .card h2 {
      margin: 0 0 10px;
      font-size: 28px;
    }

    .meta {
      color: var(--muted);
      font-size: 14px;
    }

    .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .ok { background: var(--ok); }
    .warn { background: var(--warn); }
    .bad { background: var(--bad); }

    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 14px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border-bottom: 1px solid var(--line);
      text-align: left;
      padding: 8px 10px;
      vertical-align: middle;
    }

    th { background: #e7f0fb; }

    #dockerTable th:nth-child(1),
    #dockerTable td:nth-child(1) {
      width: 30%;
      padding-right: 24px;
    }

    #dockerTable th:nth-child(2),
    #dockerTable td:nth-child(2) {
      width: 18%;
      padding-left: 20px;
    }

    #dockerRows td:nth-child(1),
    #dockerRows td:nth-child(2),
    #dockerRows td:nth-child(5) {
      white-space: nowrap;
    }

    #dockerRows td:nth-child(3),
    #dockerRows td:nth-child(4) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 0;
    }

    .collapsible-cell {
      cursor: pointer;
      user-select: none;
      overflow: hidden;
    }

    .collapsible-cell .short,
    .collapsible-cell .full {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .collapsible-cell .full {
      display: none;
    }

    .collapsible-cell.expanded .short {
      display: none;
    }

    .collapsible-cell.expanded .full {
      display: inline;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .st {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      min-width: 146px;
      line-height: 1;
      box-sizing: border-box;
    }

    .st-run {
      background: #d9ebff;
      color: #0f4f99;
      border: 1px solid #9dc5f2;
    }

    .st-healthy {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .st-stop {
      background: #ffe0e0;
      color: #9b2c2c;
      border: 1px solid #f0b3b3;
    }

    .st-info {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    .services {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }

    .service-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }

    .service-item[data-service-key="chalana-frontend"],
    .service-item[data-service-key="chalana-backend"] {
      grid-column: 1;
    }

    .service-toggle {
      all: unset;
      box-sizing: border-box;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      padding: 10px;
      cursor: pointer;
    }

    .service-toggle:hover {
      background: #f8fbff;
    }

    .service-info {
      display: grid;
      gap: 4px;
      min-width: 0;
    }

    .service-detail {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
      padding: 0 10px 10px;
      display: none;
    }

    .service-item.open .service-detail {
      display: block;
    }

    .card-tools {
      display: flex;
      gap: 10px;
      align-items: end;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .tool-field {
      display: grid;
      gap: 4px;
      min-width: 180px;
      flex: 1;
    }

    .tool-field label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    .tool-field input,
    .tool-field select {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background: #fff;
      color: var(--ink);
    }

    .alerts-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      color: var(--ink);
    }

    .alerts-list li {
      line-height: 1.3;
    }

    .traffic-wrap {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      min-width: 0;
    }

    .traffic-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .traffic-title {
      font-size: 14px;
      font-weight: 700;
      color: #1f3f67;
    }

    .traffic-legend {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: #3f5f85;
    }

    .traffic-meta {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    #trafficChartCanvas {
      display: block;
      width: 100%;
      height: 150px;
      border-radius: 8px;
      background: linear-gradient(180deg, #f7fbff 0%, #ffffff 100%);
      margin-bottom: 8px;
    }

    .api-status {
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.35;
    }

    .api-line strong {
      color: var(--ink);
    }

    .api-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .api-badge {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.35px;
      white-space: nowrap;
    }

    .api-badge::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    .api-badge.ok {
      background: #dff6e7;
      border-color: #9fd7b2;
      color: #17623a;
    }

    .api-badge.bad {
      background: #ffe2e2;
      border-color: #efb1b1;
      color: #9b2c2c;
    }

    .api-error-text {
      display: inline-block;
      max-width: min(100%, 920px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: bottom;
    }

    .footer {
      color: var(--muted);
      font-size: 12px;
      text-align: right;
    }

    .sys-top {
      color: var(--muted);
      font-size: 15px;
      margin-bottom: 6px;
    }

    .sys-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 4px;
    }

    .sys-head h2 {
      margin: 0;
      font-size: 28px;
    }

    .sys-uptime {
      color: #1f3f67;
      font-size: 15px;
      font-weight: 700;
      margin: 0;
      text-align: right;
    }

    .sys-specs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      align-items: stretch;
    }

    .spec {
      position: relative;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--line);
      padding: 12px;
      min-width: 0;
      overflow: hidden;
    }

    .spec::after {
      position: absolute;
      right: 10px;
      bottom: 6px;
      font-size: 52px;
      line-height: 1;
      font-weight: 800;
      opacity: 0.14;
      pointer-events: none;
    }

    .sys-specs .spec:nth-child(1) {
      background: linear-gradient(145deg, #fff6df, #ffe8b8);
      border-color: #f2cf80;
      color: #3d2a00;
    }

    .sys-specs .spec:nth-child(1)::after {
      content: "CPU";
      color: #7b4f00;
    }

    .sys-specs .spec:nth-child(2) {
      background: linear-gradient(145deg, #e6f6ff, #cfeeff);
      border-color: #98cde8;
      color: #032f45;
    }

    .sys-specs .spec:nth-child(2)::after {
      content: "RAM";
      color: #0a4f73;
    }

    .sys-specs .spec:nth-child(3) {
      background: linear-gradient(145deg, #eafceb, #d4f5d7);
      border-color: #9fdfab;
      color: #093516;
    }

    .sys-specs .spec:nth-child(3)::after {
      content: "SSD";
      color: #2b6f3a;
    }

    .spec-label {
      color: currentColor;
      opacity: 0.85;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .spec-value {
      font-size: 24px;
      font-weight: 800;
      line-height: 1.15;
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;    
    }

    .ram-chart-wrap {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 10px 12px;
    }

    .ram-chart-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .ram-chart-title {
      font-size: 14px;
      font-weight: 700;
      color: #1f3f67;
    }

    .ram-chart-meta {
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    .ram-chart-legend {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: #3f5f85;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    #ramChartCanvas {
      display: block;
      width: 100%;
      height: 150px;
      border-radius: 8px;
      background: linear-gradient(180deg, #f7fbff 0%, #ffffff 100%);
    }

    @media (max-width: 900px) {
      .hero { min-height: 180px; padding: 24px 18px; }
      .hero h1 { font-size: 44px; }
      .hero p { font-size: 24px; }

      .card, .card.full { grid-column: span 12; }
      .sys-specs { grid-template-columns: 1fr; }
      .services { grid-template-columns: 1fr; }
      .sys-head {
        flex-direction: column;
        align-items: flex-start;
      }
      .sys-uptime {
        text-align: left;
      }
    }

/* Alinhar largura do banner com o card Sistema */
.page .top-stack {
  width: 100% !important;
  grid-template-columns: repeat(12, minmax(0, 1fr)) !important;
}

.page .top-stack > .hero {
  width: 100% !important;
  max-width: none !important;
  min-width: 0 !important;
  grid-column: 1 / -1 !important;
  justify-self: stretch !important;
  margin: 0 !important;
}

  </style>
</head>
<body>
  <section class="auth-shell" id="loginView">
    <div class="auth-kicker">Portaleco VPS Monitor</div>
    <h2>Acesso ao Monitor</h2>
    <div class="auth-subtitle">Painel de operação e observabilidade da infraestrutura.</div>
    <div class="auth-msg" id="loginMsg">Informe suas credenciais para continuar.</div>
    <form id="loginForm">
      <label class="auth-label" for="usernameInput">Usuário</label>
      <input class="auth-input" id="usernameInput" name="username" autocomplete="username" placeholder="ex.: admin" required />
      <label class="auth-label" for="passwordInput">Senha</label>
      <div class="pw-wrap">
        <input class="auth-input" id="passwordInput" name="password" type="password" autocomplete="current-password" placeholder="Digite sua senha" required />
        <button class="pw-toggle" type="button" data-pw-toggle="passwordInput" data-pw-icon="true" aria-label="Mostrar senha" title="Mostrar senha">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M2 12s3.8-6 10-6 10 6 10 6-3.8 6-10 6-10-6-10-6z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
      <div class="caps-warning" id="capsWarning">Caps Lock está ligado.</div>
      <button class="auth-btn" id="loginBtn" type="submit">Entrar</button>
    </form>
  </section>

  <div class="page" id="dashboardView" style="display:none;">
    <div class="session-bar">
      <span class="session-user" id="sessionUser"></span>
      <button class="gear-btn" id="openUsersModalBtn" type="button" title="Configuração de usuários" style="display:none;">&#9881;</button>
      <button class="logout-btn" id="logoutBtn" type="button">Sair</button>
    </div>
    <section class="top-stack">
      <section class="hero">
        <h1>Monitor VPS</h1>
        <p>Monitoramento do Servidor - VPS</p>
      </section>

      <article class="card full">
        <div class="sys-head">
          <h2>Sistema</h2>
          <div class="sys-uptime" id="sysUptime">Tempo ativo: --</div>
        </div>
        <div class="sys-top" id="sysMeta">Carregando...</div>
        <div class="sys-specs">
          <div class="spec">
            <div class="spec-label">VM CPU</div>
            <div class="spec-value" id="cpuSpec">--</div>
          </div>
          <div class="spec">
            <div class="spec-label">VM RAM</div>
            <div class="spec-value" id="ramSpec">--</div>
          </div>
          <div class="spec">
            <div class="spec-label">VM Disco</div>
            <div class="spec-value" id="diskSpec">--</div>
          </div>
        </div>
        <div class="sys-top" id="extraDisksMeta">HDs adicionais: --</div>
        <div class="ram-chart-wrap">
          <div class="ram-chart-head">
            <div class="ram-chart-title">Oscilação em tempo real (RAM, CPU, Armazenamento)</div>
            <div class="ram-chart-legend">
              <span class="legend-item"><span class="legend-dot" style="background:#2f6fb6;"></span>RAM</span>
              <span class="legend-item"><span class="legend-dot" style="background:#d9822b;"></span>CPU</span>
              <span class="legend-item"><span class="legend-dot" style="background:#2d9a6b;"></span>Armazenamento</span>
            </div>
            <div class="ram-chart-meta" id="ramChartMeta">Coletando amostras...</div>
          </div>
          <canvas id="ramChartCanvas"></canvas>
        </div>
      </article>
    </section>

    <div class="grid">
      <article class="card full">
        <div class="api-head">
          <h2>Status da API</h2>
          <span class="api-badge ok" id="apiBadge">Online</span>
        </div>
        <div class="api-status" id="apiStatus">
          <div class="api-line">Último sucesso: <strong>aguardando</strong></div>
          <div class="api-line">Último erro: <strong>nenhum</strong></div>
        </div>
      </article>

      <article class="card full">
        <h2>Tráfego de Rede</h2>
        <div class="traffic-wrap">
          <div class="traffic-head">
            <div class="traffic-title">Taxa de tráfego (Download + Upload)</div>
            <div class="traffic-legend" id="trafficLegend"></div>
          </div>
          <canvas id="trafficChartCanvas"></canvas>
          <div class="traffic-meta" id="trafficMeta">
            Coletando tráfego...
          </div>
        </div>
      </article>

      <article class="card full">
        <div class="api-head">
          <h2>Alertas Ativos</h2>
          <span class="api-badge ok" id="alertsBadge">Sem alertas</span>
        </div>
        <div class="api-status" id="alertsList">
          <div class="api-line">Sem alertas ativos.</div>
        </div>
      </article>

      <article class="card full">
        <h2>Serviços</h2>
        <div class="card-tools">
          <div class="tool-field" style="max-width: 240px;">
            <label for="serviceEnvFilter">Ambiente</label>
            <select id="serviceEnvFilter">
              <option value="all">Todos</option>
              <option value="production" selected>Produção</option>
              <option value="staging">Staging</option>
            </select>
          </div>
          <div class="tool-field">
            <label for="serviceSearchInput">Busca de serviço</label>
            <input id="serviceSearchInput" placeholder="Ex.: monitor, chalana, cloudflare" />
          </div>
        </div>
        <div class="meta" id="servicesMeta">Carregando...</div>
        <div class="services" id="services"></div>
      </article>

      <article class="card full">
        <h2>Containers Docker</h2>
        <div class="card-tools">
          <div class="tool-field">
            <label for="dockerSearchInput">Busca de container</label>
            <input id="dockerSearchInput" placeholder="Ex.: CTR-MONITOR, CTR-CHALANA" />
          </div>
        </div>
        <div class="meta" id="dockerMeta">Carregando...</div>
        <div style="margin-top:10px; overflow:auto;">
          <table id="dockerTable">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Status</th>
                <th>Imagem</th>
                <th>Ports</th>
                <th>Rede</th>
              </tr>
            </thead>
            <tbody id="dockerRows"></tbody>
          </table>
        </div>
      </article>
    </div>

    <div class="footer" id="updatedAt">Atualizando...</div>
  </div>

  <section class="users-modal" id="usersModal" aria-hidden="true">
    <article class="users-panel">
      <div class="users-panel-head">
        <h2>Usuários</h2>
        <div style="display:flex; gap:8px;">
          <button class="logout-btn" id="changePasswordBtn" type="button">Trocar senha</button>
          <button class="logout-btn" id="closeUsersModalBtn" type="button">Fechar</button>
        </div>
      </div>
      <div class="users-toolbar">
          <div class="users-field">
            <label for="newUsername">Usuário</label>
            <input id="newUsername" placeholder="ex: suporte.portaleco" />
          </div>
          <div class="users-field">
            <label for="newPassword">Senha inicial</label>
            <div class="pw-wrap">
              <input class="auth-input" id="newPassword" type="password" placeholder="mínimo 8 caracteres" />
              <button class="pw-toggle" type="button" data-pw-toggle="newPassword">Mostrar</button>
            </div>
            <div class="field-help">Use senha forte: 8+ caracteres, maiúscula, minúscula, número e símbolo.</div>
          </div>
          <div class="users-field" style="max-width:160px;">
            <label for="newRole">Perfil</label>
            <select id="newRole">
              <option value="viewer">viewer</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <button class="primary-btn" id="createUserBtn" type="button">Criar usuário</button>
        <div class="meta" id="usersMeta">Carregando usuários...</div>
        <div style="margin-top:10px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Usuário</th>
                <th>Perfil</th>
                <th>Status</th>
                <th>Atualizado</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody id="usersRows"></tbody>
          </table>
        </div>
      </div>
    </article>
  </section>

  <script>
    const API_TIMEOUT_MS = 10000;
    const RAM_POLL_MS = 3000;
    const RAM_HISTORY_MAX_POINTS = 80;
    const TRAFFIC_HISTORY_MAX_POINTS = 80;
    const TRAFFIC_SERIES_LIMIT = 4;
    const TRAFFIC_COLORS = ["#e38b2a", "#2d9a6b", "#9b59b6", "#27a3a3", "#c95d2e", "#5b6fd9"];
    let pollHandle = null;
    let ramPollHandle = null;
    let currentUser = "";
    let currentRole = "";
    let expandedServiceName = "";
    let selectedServiceEnv = localStorage.getItem("service_env_filter") || "production";
    let serviceSearchTerm = localStorage.getItem("service_search_term") || "";
    let dockerSearchTerm = localStorage.getItem("docker_search_term") || "";
    let lastApiOkAt = null;
    let lastApiErrorAt = null;
    let lastApiErrorMessage = "";
    const ramHistory = [];
    const trafficHistory = [];

    const fmtBytes = (n) => {
      const num = Number(n || 0);
      if (num <= 0) return "0 B";
      const u = ["B","KB","MB","GB","TB"];
      let i = 0, v = num;
      while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; }
      return v.toFixed(i === 0 ? 0 : 2) + " " + u[i];
    };

    const fmtNum = (n) => Number(n || 0).toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    const fmtRate = (bytesPerSecond) => {
      const bps = Number(bytesPerSecond || 0);
      if (bps < 1024) return bps.toFixed(0) + " B/s";
      if (bps < 1024 ** 2) return (bps / 1024).toFixed(1) + " KB/s";
      if (bps < 1024 ** 3) return (bps / (1024 ** 2)).toFixed(2) + " MB/s";
      return (bps / (1024 ** 3)).toFixed(2) + " GB/s";
    };

    const toGb = (n) => Number(n || 0) / (1024 ** 3);
    const toMb = (n) => Number(n || 0) / (1024 ** 2);
    const fmtUptime = (seconds) => {
      let total = Math.max(0, Number(seconds || 0));
      const days = Math.floor(total / 86400);
      total -= days * 86400;
      const hours = Math.floor(total / 3600);
      total -= hours * 3600;
      const minutes = Math.floor(total / 60);
      const parts = [];
      if (days > 0) parts.push(days + "d");
      if (hours > 0 || days > 0) parts.push(hours + "h");
      parts.push(minutes + "min");
      return parts.join(" ");
    };
    const fmtDateTime = (date) => date.toLocaleString("pt-BR");
    const passwordToggleIcon = (visible) => {
      if (visible) {
        return '<svg viewBox="0 0 24 24" aria-hidden="true">' +
          '<path d="M2 12s3.8-6 10-6 10 6 10 6-3.8 6-10 6-10-6-10-6z"></path>' +
          '<circle cx="12" cy="12" r="3"></circle>' +
          '<path d="M3 3l18 18"></path>' +
        '</svg>';
      }
      return '<svg viewBox="0 0 24 24" aria-hidden="true">' +
        '<path d="M2 12s3.8-6 10-6 10 6 10 6-3.8 6-10 6-10-6-10-6z"></path>' +
        '<circle cx="12" cy="12" r="3"></circle>' +
      '</svg>';
    };
    const fmtAgo = (date) => {
      if (!date) return "";
      const sec = Math.max(0, Math.floor((Date.now() - date.getTime()) / 1000));
      if (sec < 5) return "agora";
      if (sec < 60) return "há " + sec + "s";
      const min = Math.floor(sec / 60);
      if (min < 60) return "há " + min + "min";
      const hr = Math.floor(min / 60);
      if (hr < 24) return "há " + hr + "h";
      const day = Math.floor(hr / 24);
      return "há " + day + "d";
    };
    const escapeHtml = (value) => String(value || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");

    const dot = (ok) =>
      '<span class="dot ' + (ok ? 'ok' : 'bad') + '"></span>' + (ok ? "Online" : "Offline");

    const friendlyServiceName = (rawName) => {
      const name = String(rawName || "").trim();
      const capitalizeFirst = (text) => {
        const value = String(text || "");
        if (!value) return value;
        return value.charAt(0).toUpperCase() + value.slice(1);
      };
      const exactMap = {
        "chalana-api": "Chalana (API)",
        "firebird25": "Firebird (Container)",
        "cloudflared-guardiao": "Cloudflared-guardiao",
        "nginx-proxy-manager": "Nginx Proxy Manager",
        "portainer": "Portainer",
        "portaleco-panel": "Portaleco Panel",
        "portaleco-chalana-chalana-1": "Chalana (Backend)",
        "portaleco-chalana-portaleco-chalana-frontend-1": "Chalana (Frontend)",
        "portaleco-vps-monitor-backend": "Monitor (Backend)",
        "portaleco-vps-monitor-frontend": "Monitor (Frontend)",
        "portaleco-vps-monitor-backend-staging": "Monitor (Backend - Staging)",
        "portaleco-vps-monitor-frontend-staging": "Monitor (Frontend - Staging)",
        "tunnel": "Tunnel Cloudflare",
        "firebird monitor": "Firebird (Monitoria)"
      };
      if (exactMap[name]) return capitalizeFirst(exactMap[name]);
      return capitalizeFirst(name
        .replace(/^portaleco-vps-monitor-/, "Monitor ")
        .replace(/^portaleco-chalana-/, "Chalana ")
        .replace(/-/g, " ")
        .replace(/\b\w/g, (c) => c.toUpperCase()));
    };

    const containerDisplayName = (rawName) => {
      const name = String(rawName || "").trim();
      const exactMap = {
        "chalana-api": "ctr-chalana-api",
        "portaleco-chalana-chalana-1": "ctr-chalana-backend",
        "portaleco-chalana-portaleco-chalana-frontend-1": "ctr-chalana-frontend",
        "portaleco-vps-monitor-backend": "ctr-monitor-backend",
        "portaleco-vps-monitor-frontend": "ctr-monitor-frontend",
        "portaleco-vps-monitor-backend-staging": "ctr-monitor-backend-staging",
        "portaleco-vps-monitor-frontend-staging": "ctr-monitor-frontend-staging",
        "cloudflared-guardiao": "ctr-cloudflared-guardiao",
        "firebird25": "ctr-firebird25",
        "nginx-proxy-manager": "ctr-nginx-proxy-manager",
        "portainer": "ctr-portainer",
        "portaleco-panel": "ctr-portaleco-panel"
      };
      const base = exactMap[name] || ("ctr-" + name.toLowerCase().replace(/[^a-z0-9-]/g, "-"));
      return base.toUpperCase();
    };

    const serviceLayoutKey = (rawName) => {
      const name = String(rawName || "").trim().toLowerCase();
      if (
        name === "portaleco-chalana-portaleco-chalana-frontend-1" ||
        name === "chalana frontend"
      ) return "chalana-frontend";
      if (
        name === "portaleco-chalana-chalana-1" ||
        name === "chalana backend"
      ) return "chalana-backend";
      return name;
    };

    const detectEnvironment = (rawName) => {
      const name = String(rawName || "").toLowerCase();
      return name.includes("staging") ? "staging" : "production";
    };

    const normalizeSearch = (value) =>
      String(value || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();

    const isContainerProblem = (container) => {
      const state = String(container?.state || "").toLowerCase();
      const status = String(container?.status || "").toLowerCase();
      if (status.includes("unhealthy")) return true;
      if (state === "restarting" || state === "paused" || state === "dead") return true;
      return state !== "running";
    };

    const dockerStateBadge = (container) => {
      const state = String(container?.state || "").toLowerCase();
      const status = String(container?.status || "").toLowerCase();

      if (state === "created" || status.includes("created")) {
        return { label: "Criado", cls: "st-info" };
      }
      if (state === "running" && status.includes("healthy")) {
        return { label: "Saudavel", cls: "st-healthy" };
      }
      if (state === "running" || status.includes("running") || status.startsWith("up")) {
        return { label: "Em execucao", cls: "st-run" };
      }
      if (state === "restarting" || status.includes("restarting")) {
        return { label: "Reiniciando", cls: "st-info" };
      }
      if (state === "paused" || status.includes("paused")) {
        return { label: "Pausado", cls: "st-info" };
      }
      return { label: "Parado", cls: "st-stop" };
    };

    const truncateText = (value, maxLen) => {
      const text = String(value || "");
      if (text.length <= maxLen) return text;
      return text.slice(0, Math.max(0, maxLen - 1)) + "…";
    };

    const renderExpandableCell = (value, maxLen) => {
      const full = String(value || "");
      const short = truncateText(full, maxLen);
      const fullEscaped = escapeHtml(full);
      const shortEscaped = escapeHtml(short);
      if (!full || short === full) {
        return "<td>" + fullEscaped + "</td>";
      }
      return (
        "<td class='collapsible-cell' onclick='this.classList.toggle(\"expanded\")' title='Clique para expandir/recolher'>" +
          "<span class='short'>" + shortEscaped + "</span>" +
          "<span class='full'>" + fullEscaped + "</span>" +
        "</td>"
      );
    };

    const setRamChartMeta = (message) => {
      const el = document.getElementById("ramChartMeta");
      if (el) el.textContent = message;
    };
    const setTrafficMeta = (message) => {
      const el = document.getElementById("trafficMeta");
      if (el) el.textContent = message;
    };

    const setTrafficLegend = (apps) => {
      const el = document.getElementById("trafficLegend");
      if (!el) return;
      const appList = Array.isArray(apps) ? apps : [];
      const base = [
        '<span class="legend-item"><span class="legend-dot" style="background:#5165d6;"></span>Geral</span>'
      ];
      appList.forEach((app, index) => {
        const color = TRAFFIC_COLORS[index % TRAFFIC_COLORS.length];
        base.push(
          '<span class="legend-item"><span class="legend-dot" style="background:' + color + ';"></span>' +
          escapeHtml(app) + "</span>"
        );
      });
      el.innerHTML = base.join("");
    };

    const clampPercent = (value) => {
      const num = Number(value || 0);
      if (!Number.isFinite(num)) return 0;
      return Math.max(0, Math.min(100, num));
    };

    const recordRamSample = (system) => {
      const ramUsed = Number(system?.memory?.used || 0);
      const ramTotal = Number(system?.memory?.total || 0);
      if (!ramUsed || !ramTotal) return;

      ramHistory.push({
        t: Date.now(),
        ramUsed,
        ramTotal,
        ramPct: clampPercent(system?.memory?.percent),
        cpuPct: clampPercent(system?.cpu_percent),
        diskPct: clampPercent(system?.disk?.percent)
      });
      while (ramHistory.length > RAM_HISTORY_MAX_POINTS) {
        ramHistory.shift();
      }
      renderRamChart();
    };

    const renderRamChart = () => {
      const canvas = document.getElementById("ramChartCanvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const rect = canvas.getBoundingClientRect();
      const width = Math.max(320, Math.floor(rect.width));
      const height = 150;
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(width * dpr);
      canvas.height = Math.floor(height * dpr);
      canvas.style.height = height + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, width, height);

      const pad = { top: 12, right: 12, bottom: 20, left: 12 };
      const plotW = width - pad.left - pad.right;
      const plotH = height - pad.top - pad.bottom;

      ctx.strokeStyle = "#e5eef9";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = pad.top + (plotH * i) / 4;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(width - pad.right, y);
        ctx.stroke();
      }

      if (ramHistory.length < 2) {
        setRamChartMeta("Coletando amostras...");
        return;
      }

      const points = ramHistory.map((s) => ({
        ramPct: s.ramPct,
        cpuPct: s.cpuPct,
        diskPct: s.diskPct,
        ramUsed: s.ramUsed,
        ramTotal: s.ramTotal
      }));
      const minPct = 0;
      const maxPct = 100;
      const span = 100;

      const toX = (i) => pad.left + (i * plotW) / Math.max(1, points.length - 1);
      const toY = (pct) => pad.top + (1 - (pct - minPct) / span) * plotH;

      const drawSeries = (key, color) => {
        ctx.beginPath();
        points.forEach((p, i) => {
          const x = toX(i);
          const y = toY(p[key]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.lineWidth = 2;
        ctx.strokeStyle = color;
        ctx.stroke();
      };

      drawSeries("ramPct", "#2f6fb6");
      drawSeries("cpuPct", "#d9822b");
      drawSeries("diskPct", "#2d9a6b");

      const last = points[points.length - 1];
      const markLast = (pct, color) => {
        const lx = toX(points.length - 1);
        const ly = toY(pct);
        ctx.beginPath();
        ctx.arc(lx, ly, 3, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
      };
      markLast(last.ramPct, "#2f6fb6");
      markLast(last.cpuPct, "#d9822b");
      markLast(last.diskPct, "#2d9a6b");

      ctx.fillStyle = "#3f5f85";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
      ctx.fillText(minPct.toFixed(0) + "%", pad.left, height - 5);
      const maxText = maxPct.toFixed(0) + "%";
      const maxTextWidth = ctx.measureText(maxText).width;
      ctx.fillText(maxText, width - pad.right - maxTextWidth, height - 5);

      setRamChartMeta(
        "RAM: " + last.ramPct.toFixed(1) + "% | CPU: " + last.cpuPct.toFixed(1) + "% | Armazenamento: " + last.diskPct.toFixed(1) + "%"
      );
    };

    const recordTrafficSample = (traffic) => {
      const apps = Array.isArray(traffic?.applications) ? traffic.applications : [];
      const selectedApps = apps
        .slice()
        .sort((a, b) =>
          (Number(b?.rx_bps || 0) + Number(b?.tx_bps || 0)) -
          (Number(a?.rx_bps || 0) + Number(a?.tx_bps || 0))
        )
        .slice(0, TRAFFIC_SERIES_LIMIT);
      const appRates = {};
      const appRx = {};
      const appTx = {};
      selectedApps.forEach((a) => {
        const name = String(a?.app || "");
        if (!name) return;
        appRates[name] = Number(a?.rx_bps || 0) + Number(a?.tx_bps || 0);
        appRx[name] = Number(a?.rx_bps || 0);
        appTx[name] = Number(a?.tx_bps || 0);
      });
      const generalRate = Number(traffic?.total?.rx_bps || 0) + Number(traffic?.total?.tx_bps || 0);
      const appKeys = Object.keys(appRates);
      setTrafficLegend(appKeys);

      trafficHistory.push({
        t: Date.now(),
        generalRate,
        generalRx: Number(traffic?.total?.rx_bps || 0),
        generalTx: Number(traffic?.total?.tx_bps || 0),
        appKeys,
        appRates,
        appRx,
        appTx
      });

      while (trafficHistory.length > TRAFFIC_HISTORY_MAX_POINTS) {
        trafficHistory.shift();
      }

      renderTrafficChart();
    };

    const renderTrafficChart = () => {
      const canvas = document.getElementById("trafficChartCanvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const rect = canvas.getBoundingClientRect();
      const width = Math.max(320, Math.floor(rect.width));
      const height = 150;
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(width * dpr);
      canvas.height = Math.floor(height * dpr);
      canvas.style.height = height + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, width, height);

      const pad = { top: 12, right: 12, bottom: 20, left: 12 };
      const plotW = width - pad.left - pad.right;
      const plotH = height - pad.top - pad.bottom;

      ctx.strokeStyle = "#e5eef9";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = pad.top + (plotH * i) / 4;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(width - pad.right, y);
        ctx.stroke();
      }

      if (trafficHistory.length < 2) {
        setTrafficMeta("Coletando tráfego...");
        return;
      }

      const maxValue = Math.max(
        1,
        ...trafficHistory.map((p) => {
          const appMax = Math.max(
            0,
            ...((p.appKeys || []).map((name) => Number(p.appRates?.[name] || 0)))
          );
          return Math.max(Number(p.generalRate || 0), appMax);
        })
      );
      const maxScale = maxValue * 1.15;

      const toX = (i) => pad.left + (i * plotW) / Math.max(1, trafficHistory.length - 1);
      const toY = (v) => pad.top + (1 - v / maxScale) * plotH;

      const drawSeries = (key, color) => {
        ctx.beginPath();
        trafficHistory.forEach((p, i) => {
          const x = toX(i);
          const y = toY(p[key]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.lineWidth = 2;
        ctx.strokeStyle = color;
        ctx.stroke();
      };

      drawSeries("generalRate", "#5165d6");
      const last = trafficHistory[trafficHistory.length - 1];
      const keys = Array.isArray(last?.appKeys) ? last.appKeys : [];
      keys.forEach((name, index) => {
        const key = "__appRate_" + name;
        trafficHistory.forEach((point) => {
          point[key] = Number(point.appRates?.[name] || 0);
        });
        drawSeries(key, TRAFFIC_COLORS[index % TRAFFIC_COLORS.length]);
      });

      const markLast = (v, color) => {
        const lx = toX(trafficHistory.length - 1);
        const ly = toY(v);
        ctx.beginPath();
        ctx.arc(lx, ly, 3, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
      };
      markLast(last.generalRate, "#5165d6");
      keys.forEach((name, index) => {
        markLast(Number(last.appRates?.[name] || 0), TRAFFIC_COLORS[index % TRAFFIC_COLORS.length]);
      });

      ctx.fillStyle = "#3f5f85";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
      ctx.fillText("0 B/s", pad.left, height - 5);
      const topLabel = fmtRate(maxScale);
      const topWidth = ctx.measureText(topLabel).width;
      ctx.fillText(topLabel, width - pad.right - topWidth, height - 5);

      const parts = [
        "Geral: ↓" + fmtRate(last.generalRx) + " ↑" + fmtRate(last.generalTx)
      ];
      keys.forEach((name) => {
        parts.push(
          name + ": ↓" + fmtRate(last.appRx?.[name] || 0) + " ↑" + fmtRate(last.appTx?.[name] || 0)
        );
      });
      setTrafficMeta(parts.join(" | "));
    };

    const startRamLivePolling = () => {
      if (ramPollHandle) return;
      ramPollHandle = setInterval(async () => {
        try {
          const systemRes = await apiFetch("/api/system");
          const system = await parseJsonResponse(systemRes);
          if (!systemRes.ok) return;
          recordRamSample(system);
        } catch (_) {
          // silencioso para não poluir UI; o polling principal já exibe erro global
        }
      }, RAM_POLL_MS);
    };

    const getUser = () => currentUser || "";
    const getRole = () => currentRole || "";
    const isAdmin = () => getRole() === "admin";
    const usersModalEl = document.getElementById("usersModal");

    const setSession = (username, role) => {
      currentUser = String(username || "");
      currentRole = String(role || "");
    };

    const setLoginMessage = (message, isError = false, isSuccess = false) => {
      const el = document.getElementById("loginMsg");
      el.textContent = message;
      el.classList.remove("is-error", "is-ok");
      if (isError) el.classList.add("is-error");
      if (isSuccess) el.classList.add("is-ok");
    };

    const getLoginErrorMessage = (status, data, rawText) => {
      const detail = String(data?.detail || data?.error || "").trim();
      const raw = String(rawText || "").trim();
      const looksLikeHtml = /^<!doctype html>|^<html[\s>]/i.test(raw);
      if (status === 401 || /autentic|credencial|invalid|inv[aá]lid/i.test(detail)) {
        return "Usuário ou senha inválidos. Verifique e tente novamente.";
      }
      if (status === 429) {
        return "Muitas tentativas de login. Aguarde alguns minutos e tente novamente.";
      }
      if (status >= 500) {
        return "Serviço de autenticação indisponível no momento. Tente novamente em instantes.";
      }
      if (detail) return detail;
      if (looksLikeHtml) {
        return "Falha na comunicação com a API de autenticação. Tente novamente.";
      }
      const preview = raw.replace(/\s+/g, " ").slice(0, 120);
      if (preview) return "Falha no login: " + preview;
      return "Falha de autenticação.";
    };

    const showLoginView = (message, isError = false) => {
      document.getElementById("loginView").style.display = "block";
      document.getElementById("dashboardView").style.display = "none";
      setLoginMessage(message, isError);
      if (pollHandle) {
        clearInterval(pollHandle);
        pollHandle = null;
      }
      if (ramPollHandle) {
        clearInterval(ramPollHandle);
        ramPollHandle = null;
      }
    };

    const showDashboardView = () => {
      document.getElementById("loginView").style.display = "none";
      document.getElementById("dashboardView").style.display = "grid";
      const user = getUser();
      const role = getRole();
      document.getElementById("sessionUser").textContent =
        user ? ("Usuário: " + user + (role ? " (" + role + ")" : "")) : "";
      document.getElementById("openUsersModalBtn").style.display = isAdmin() ? "inline-flex" : "none";
      closeUsersModal();
      if (!pollHandle) {
        pollHandle = setInterval(load, 10000);
      }
      startRamLivePolling();
    };

    const updateApiStatus = () => {
      const apiStatusEl = document.getElementById("apiStatus");
      const apiBadgeEl = document.getElementById("apiBadge");
      if (!apiStatusEl) return;

      const hasActiveError = Boolean(lastApiErrorAt && (!lastApiOkAt || lastApiErrorAt >= lastApiOkAt));
      if (apiBadgeEl) {
        apiBadgeEl.className = "api-badge " + (hasActiveError ? "bad" : "ok");
        apiBadgeEl.textContent = hasActiveError ? "Erro" : "Online";
      }

      const okText = lastApiOkAt
        ? (fmtDateTime(lastApiOkAt) + " (" + fmtAgo(lastApiOkAt) + ")")
        : "aguardando";
      const errText = lastApiErrorAt ? (fmtDateTime(lastApiErrorAt) + " (" + fmtAgo(lastApiErrorAt) + ")") : "nenhum";
      const errMessageEscaped = escapeHtml(lastApiErrorMessage || "");
      const errorLine = lastApiErrorAt
        ? "<strong>" + errText + "</strong>" + (errMessageEscaped
          ? ' <span class="api-error-text" title="' + errMessageEscaped + '">(' + errMessageEscaped + ")</span>"
          : "")
        : "<strong>nenhum</strong>";

      apiStatusEl.innerHTML =
        '<div class="api-line">Último sucesso: <strong>' + okText + '</strong></div>' +
        '<div class="api-line">Último erro: ' + errorLine + "</div>";
    };

    async function apiFetch(path, options = {}) {
      const headers = new Headers(options.headers || {});

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT_MS);
      let response;
      try {
        response = await fetch(path, {
          ...options,
          headers,
          credentials: "include",
          cache: "no-store",
          signal: options.signal || controller.signal
        });
      } catch (error) {
        if (error && error.name === "AbortError") {
          throw new Error("Timeout da API após " + Math.floor(API_TIMEOUT_MS / 1000) + "s em " + path);
        }
        throw error;
      } finally {
        clearTimeout(timeoutId);
      }
      if (response.status === 401) {
        const err = new Error("Sessão expirada. Faça login novamente.");
        err.authError = true;
        throw err;
      }

      return response;
    }

    async function parseJsonResponse(response) {
      const bodyText = await response.text();
      if (!bodyText) return {};
      try {
        return JSON.parse(bodyText);
      } catch (_) {
        const preview = bodyText.replace(/\s+/g, " ").trim().slice(0, 140);
        throw new Error(
          "Resposta invalida da API (HTTP " + response.status + ")" +
          (preview ? ": " + preview : "")
        );
      }
    }

    async function load() {
      try {
        const [systemRes, dockerRes, servicesRes, firebirdRes, tunnelRes, trafficRes] = await Promise.all([
          apiFetch("/api/system"),
          apiFetch("/api/docker"),
          apiFetch("/api/services"),
          apiFetch("/api/firebird"),
          apiFetch("/api/tunnel"),
          apiFetch("/api/traffic")
        ]);

        const [system, docker, services, firebird, tunnel, traffic] = await Promise.all([
          parseJsonResponse(systemRes),
          parseJsonResponse(dockerRes),
          parseJsonResponse(servicesRes),
          parseJsonResponse(firebirdRes),
          parseJsonResponse(tunnelRes),
          parseJsonResponse(trafficRes)
        ]);

        const diskVolumes = Array.isArray(system.disk?.volumes) ? system.disk.volumes : [];
        const extraDiskMountsBlocked = new Set(["/boot", "/boot/efi"]);
        const extraDisks = diskVolumes.filter((d) => !extraDiskMountsBlocked.has(String(d.mount || "")));
        const extraTotal = extraDisks.reduce((sum, d) => sum + Number(d.total || 0), 0);
        const extraUsed = extraDisks.reduce((sum, d) => sum + Number(d.used || 0), 0);
        const vmDiskTotal = Math.max(0, Number(system.disk?.total || 0) - extraTotal);
        const vmDiskUsed = Math.max(0, Number(system.disk?.used || 0) - extraUsed);

        document.getElementById("cpuSpec").textContent = String(system.cpu_cores || 4);
        document.getElementById("ramSpec").textContent =
          `${fmtNum(toGb(system.memory?.total))} GB / ${fmtNum(toMb(system.memory?.used))} MB`;
        document.getElementById("diskSpec").textContent =
          `${fmtNum(toGb(vmDiskTotal))} GB / ${fmtNum(toGb(vmDiskUsed))} GB`;

        const extraDiskDetails = extraDisks.length > 0
          ? extraDisks
            .map((d) => `${d.mount} ${fmtNum(toGb(d.used))}/${fmtNum(toGb(d.total))} GB (${Number(d.percent || 0).toFixed(0)}%)`)
            .join(" | ")
          : "nenhum";
        document.getElementById("extraDisksMeta").textContent =
          "HDs adicionais: " + extraDiskDetails;

        document.getElementById("sysMeta").textContent =
          "Host: " + (system.hostname || "-") +
          " | VM RAM: " + fmtBytes(system.memory?.used) + " / " + fmtBytes(system.memory?.total) +
          " | VM Disco: " + fmtBytes(vmDiskUsed) + " / " + fmtBytes(vmDiskTotal);
        const startedAt = new Date(Date.now() - (Number(system.uptime_seconds || 0) * 1000));
        document.getElementById("sysUptime").textContent =
          "Tempo ativo do servidor: " + fmtUptime(system.uptime_seconds) +
          " | Iniciado em: " + fmtDateTime(startedAt);
        recordRamSample(system);

        let dynamicServices = Array.isArray(services.items)
          ? services.items.map((item) => ({
            name: String(item?.name || ""),
            online: Boolean(item?.online),
            detail: String(item?.detail || "")
          }))
          : [];
        const toTunnelKey = (name) =>
          String(name || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/g, "");
        const tunnelAliases = new Set([
          "cloudflaredguardiao",
          "cloudflaretunnel",
          "tunnelcloudflare",
          "tunnel"
        ]);
        const tunnelCandidates = dynamicServices.filter((item) => tunnelAliases.has(toTunnelKey(item.name)));
        dynamicServices = dynamicServices.filter((item) => !tunnelAliases.has(toTunnelKey(item.name)));
        const mergedTunnelOnline =
          tunnelCandidates.some((item) => Boolean(item.online)) || Boolean(tunnel.running);
        const mergedTunnelDetailBase =
          tunnelCandidates.map((item) => String(item.detail || "").trim()).find((v) => Boolean(v)) || "";
        const tunnelDetail = "Registrado: " + (tunnel.registered ? "Sim" : "Não");
        dynamicServices.push({
          name: "cloudflared-guardiao",
          online: mergedTunnelOnline,
          detail: mergedTunnelDetailBase ? (mergedTunnelDetailBase + " | " + tunnelDetail) : tunnelDetail
        });
        const serviceCards = [
          ...dynamicServices,
          {
            name: "firebird monitor",
            online: Boolean(firebird.ok),
            detail: "Versão: " + (firebird.version || "-") + " | Resp: " + (firebird.response_ms ?? "-") + " ms"
          }
        ];
        const serviceCardsWithMeta = serviceCards.map((item) => ({
          ...item,
          displayName: friendlyServiceName(item.name),
          environment: detectEnvironment(item.name)
        }));
        const normalizedServiceSearch = normalizeSearch(serviceSearchTerm);
        const filteredServiceCards = serviceCardsWithMeta.filter((item) => {
          if (selectedServiceEnv === "staging" && item.environment !== "staging") return false;
          if (selectedServiceEnv === "production" && item.environment !== "production") return false;
          if (!normalizedServiceSearch) return true;
          const haystack = normalizeSearch(item.displayName + " " + item.name + " " + item.detail);
          return haystack.includes(normalizedServiceSearch);
        });
        const orderedServiceCards = [...filteredServiceCards].sort((a, b) => {
          if (a.online !== b.online) return a.online ? 1 : -1;
          return String(a.displayName).localeCompare(String(b.displayName), "pt-BR");
        });
        const leftCount = Math.ceil(orderedServiceCards.length / 2);
        const leftColumn = orderedServiceCards.slice(0, leftCount);
        const rightColumn = orderedServiceCards.slice(leftCount);
        const displayServiceCards = [];
        for (let i = 0; i < leftCount; i += 1) {
          if (leftColumn[i]) displayServiceCards.push(leftColumn[i]);
          if (rightColumn[i]) displayServiceCards.push(rightColumn[i]);
        }
        const serviceOfflineCount = serviceCardsWithMeta.filter((item) => !item.online).length;
        document.getElementById("servicesMeta").textContent =
          "Exibindo: " + displayServiceCards.length +
          " de " + serviceCardsWithMeta.length +
          " | Offline: " + serviceOfflineCount +
          " | Ordem: Offline primeiro e alfabética";

        const servicesEl = document.getElementById("services");
        servicesEl.innerHTML = displayServiceCards.map((item) => {
          const safeName = escapeHtml(item.displayName);
          const safeDetail = escapeHtml(item.detail);
          const isExpanded = expandedServiceName === String(item.name || "");
          const expandedClass = isExpanded ? " open" : "";
          const expandedAttr = isExpanded ? "true" : "false";
          const serviceNameAttr = escapeHtml(item.name || "");
          const serviceKeyAttr = escapeHtml(serviceLayoutKey(item.name || ""));
          return '<div class="service-item' + expandedClass + '" data-service-key="' + serviceKeyAttr + '">' +
            '<button type="button" class="service-toggle" data-service-name="' + serviceNameAttr + '" aria-expanded="' + expandedAttr + '">' +
              '<div class="service-info">' +
                '<strong>' + safeName + '</strong>' +
              '</div>' +
              '<span>' + dot(item.online) + '</span>' +
            '</button>' +
            '<div class="service-detail">' + safeDetail + '</div>' +
          '</div>';
        }).join("");
        servicesEl.querySelectorAll(".service-toggle").forEach((btn) => {
          btn.addEventListener("click", () => {
            const selected = btn.getAttribute("data-service-name") || "";
            const isOpen = btn.closest(".service-item")?.classList.contains("open");
            expandedServiceName = isOpen ? "" : selected;
            servicesEl.querySelectorAll(".service-item").forEach((itemEl) => {
              itemEl.classList.toggle("open", itemEl.querySelector(".service-toggle")?.getAttribute("data-service-name") === expandedServiceName);
            });
            servicesEl.querySelectorAll(".service-toggle").forEach((toggleEl) => {
              toggleEl.setAttribute("aria-expanded", String(toggleEl.getAttribute("data-service-name") === expandedServiceName));
            });
          });
        });

        recordTrafficSample(traffic);

        const dockerItems = (docker.containers || []).map((c) => ({
          ...c,
          displayName: containerDisplayName(c.name || "")
        }));
        const normalizedDockerSearch = normalizeSearch(dockerSearchTerm);
        const filteredDockerItems = dockerItems
          .filter((item) => {
            if (!normalizedDockerSearch) return true;
            const haystack = normalizeSearch(
              item.displayName + " " + (item.name || "") + " " + (item.image || "") + " " + (item.network || "")
            );
            return haystack.includes(normalizedDockerSearch);
          })
          .sort((a, b) =>
            String(a.displayName).localeCompare(String(b.displayName), "pt-BR")
          );
        const dockerProblemCount = dockerItems.filter((item) => isContainerProblem(item)).length;
        document.getElementById("dockerMeta").textContent =
          "Total: " + (docker.total || 0) +
          " | Em execucao: " + (docker.running || 0) +
          " | Exibindo: " + filteredDockerItems.length +
          " | Problemas: " + dockerProblemCount;

        const rows = filteredDockerItems.map((c) => {
          const badge = dockerStateBadge(c);
          const safeName = escapeHtml(c.displayName || "");
          const safeNetwork = escapeHtml(c.network || "");
          return (
          "<tr>" +
            "<td>" + safeName + "</td>" +
            "<td><span class='st " + badge.cls + "'>" + badge.label + "</span></td>" +
            renderExpandableCell(c.image || "", 42) +
            renderExpandableCell(c.ports || "", 28) +
            "<td>" + safeNetwork + "</td>" +
          "</tr>"
          );
        }).join("");

        document.getElementById("dockerRows").innerHTML =
          rows || "<tr><td colspan='5'>Sem dados</td></tr>";

        const alerts = [];
        serviceCardsWithMeta
          .filter((item) => !item.online)
          .forEach((item) => alerts.push("Serviço offline: " + item.displayName));
        dockerItems
          .filter((item) => isContainerProblem(item))
          .forEach((item) => alerts.push("Container com problema: " + item.displayName + " (" + (item.status || item.state || "-") + ")"));
        const alertsBadgeEl = document.getElementById("alertsBadge");
        const alertsListEl = document.getElementById("alertsList");
        if (alerts.length === 0) {
          alertsBadgeEl.className = "api-badge ok";
          alertsBadgeEl.textContent = "Sem alertas";
          alertsListEl.innerHTML = '<div class="api-line">Sem alertas ativos.</div>';
        } else {
          alertsBadgeEl.className = "api-badge bad";
          alertsBadgeEl.textContent = alerts.length + " alerta(s)";
          alertsListEl.innerHTML = '<ul class="alerts-list">' +
            alerts.slice(0, 12).map((msg) => "<li>" + escapeHtml(msg) + "</li>").join("") +
            "</ul>";
        }

        document.getElementById("updatedAt").textContent =
          "Atualizado em: " + new Date().toLocaleString("pt-BR");
        lastApiOkAt = new Date();
        updateApiStatus();

        if (isAdmin() && usersModalEl.classList.contains("open")) {
          await loadUsers();
        }
      } catch (e) {
        if (e.authError) {
          setSession("", "");
          showLoginView(e.message, true);
          return;
        }
        lastApiErrorAt = new Date();
        lastApiErrorMessage = e.message || "erro desconhecido";
        updateApiStatus();
        document.getElementById("updatedAt").textContent = "Erro ao atualizar: " + e.message;
      }
    }

    async function loadUsers() {
      if (!isAdmin()) return;
      try {
        const response = await apiFetch("/api/auth/users");
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao carregar usuários");
        }

        const users = Array.isArray(data.users) ? data.users : [];
        document.getElementById("usersMeta").textContent = "Total: " + users.length;
        document.getElementById("usersRows").innerHTML = users.map((u) => {
          const actionLabel = u.active ? "Desativar" : "Ativar";
          const safeUsername = escapeHtml(u.username || "-");
          const safeRole = escapeHtml(u.role || "-");
          const safeUpdatedAt = escapeHtml(u.updated_at || "-");
          const safeUsernameAttr = escapeHtml(u.username || "");
          return "<tr>" +
            "<td>" + safeUsername + "</td>" +
            "<td>" + safeRole + "</td>" +
            "<td>" + (u.active ? "<span class='st st-run'>Ativo</span>" : "<span class='st st-stop'>Inativo</span>") + "</td>" +
            "<td>" + safeUpdatedAt + "</td>" +
            "<td><button class='mini-btn' data-user-toggle='" + safeUsernameAttr + "' data-user-active='" + (u.active ? "1" : "0") + "'>" + actionLabel + "</button></td>" +
          "</tr>";
        }).join("") || "<tr><td colspan='5'>Sem usuários</td></tr>";
      } catch (error) {
        document.getElementById("usersMeta").textContent = "Erro ao carregar usuários: " + error.message;
      }
    }

    document.getElementById("loginForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const username = document.getElementById("usernameInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      const button = document.getElementById("loginBtn");
      if (!username || !password) {
        setLoginMessage("Preencha usuário e senha para continuar.", true);
        return;
      }
      button.disabled = true;
      setLoginMessage("Autenticando...");

      try {
        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          cache: "no-store",
          body: JSON.stringify({ username, password })
        });
        const rawText = await response.text();
        let data = {};
        if (rawText) {
          try {
            data = JSON.parse(rawText);
          } catch (_) {
            data = {};
          }
        }

        if (!response.ok) {
          throw new Error(getLoginErrorMessage(response.status, data, rawText));
        }

        if (data.auth_enabled === false) {
          setSession(data.user?.username || username || "local", data.user?.role || "admin");
          showDashboardView();
          await load();
          return;
        }

        setSession(data.user?.username || username, data.user?.role || "viewer");
        setLoginMessage("Login realizado com sucesso.", false, true);
        showDashboardView();
        await load();
      } catch (error) {
        const msg = String(error?.message || "");
        if (/Failed to fetch|NetworkError|Load failed/i.test(msg)) {
          setLoginMessage("Não foi possível conectar à API. Verifique a conectividade e tente novamente.", true);
        } else {
          setLoginMessage(msg || "Falha de autenticação.", true);
        }
      } finally {
        button.disabled = false;
      }
    });

    const passwordInputEl = document.getElementById("passwordInput");
    const capsWarningEl = document.getElementById("capsWarning");
    if (passwordInputEl && capsWarningEl) {
      const handleCapsWarning = (event) => {
        const isCaps = Boolean(event?.getModifierState?.("CapsLock"));
        capsWarningEl.classList.toggle("open", isCaps);
      };
      passwordInputEl.addEventListener("keydown", handleCapsWarning);
      passwordInputEl.addEventListener("keyup", handleCapsWarning);
      passwordInputEl.addEventListener("blur", () => capsWarningEl.classList.remove("open"));
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
          cache: "no-store"
        });
      } catch (_) {
        // ignora falha de rede no logout e limpa sessao local mesmo assim
      }
      setSession("", "");
      showLoginView("Sessão encerrada.");
    });

    document.getElementById("changePasswordBtn").addEventListener("click", async () => {
      const currentPassword = window.prompt("Informe sua senha atual:");
      if (currentPassword === null) return;
      const newPassword = window.prompt("Informe a nova senha (mínimo 8 caracteres):");
      if (newPassword === null) return;
      const confirmPassword = window.prompt("Confirme a nova senha:");
      if (confirmPassword === null) return;

      if (newPassword.length < 8) {
        window.alert("A nova senha precisa ter no mínimo 8 caracteres.");
        return;
      }
      if (newPassword !== confirmPassword) {
        window.alert("A confirmação da senha não confere.");
        return;
      }

      try {
        const response = await apiFetch("/api/auth/change-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
          })
        });
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao alterar senha.");
        }
        window.alert("Senha alterada com sucesso.");
      } catch (error) {
        window.alert(error.message || "Falha ao alterar senha.");
      }
    });

    const openUsersModal = async () => {
      if (!isAdmin()) return;
      usersModalEl.classList.add("open");
      usersModalEl.setAttribute("aria-hidden", "false");
      await loadUsers();
    };

    const closeUsersModal = () => {
      usersModalEl.classList.remove("open");
      usersModalEl.setAttribute("aria-hidden", "true");
    };

    document.getElementById("openUsersModalBtn").addEventListener("click", () => {
      openUsersModal();
    });

    document.getElementById("closeUsersModalBtn").addEventListener("click", () => {
      closeUsersModal();
    });

    usersModalEl.addEventListener("click", (event) => {
      if (event.target === usersModalEl) {
        closeUsersModal();
      }
    });

    document.getElementById("createUserBtn").addEventListener("click", async () => {
      const username = document.getElementById("newUsername").value.trim();
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;

      if (!username || !password) {
        window.alert("Preencha usuário e senha.");
        return;
      }
      if (password.length < 8) {
        window.alert("A senha precisa ter no mínimo 8 caracteres.");
        return;
      }

      try {
        const response = await apiFetch("/api/auth/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role })
        });
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao criar usuário");
        }
        document.getElementById("newUsername").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("newRole").value = "viewer";
        await loadUsers();
      } catch (error) {
        window.alert(error.message || "Falha ao criar usuário");
      }
    });

    document.getElementById("usersRows").addEventListener("click", async (event) => {
      const btn = event.target.closest("button[data-user-toggle]");
      if (!btn) return;
      const username = btn.getAttribute("data-user-toggle");
      const currentlyActive = btn.getAttribute("data-user-active") === "1";
      const nextActive = !currentlyActive;

      try {
        const response = await apiFetch("/api/auth/users/" + encodeURIComponent(username) + "/active", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ active: nextActive })
        });
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao atualizar usuário");
        }
        await loadUsers();
      } catch (error) {
        window.alert(error.message || "Falha ao atualizar usuário");
      }
    });

    document.getElementById("serviceEnvFilter").addEventListener("change", (event) => {
      selectedServiceEnv = String(event.target.value || "all");
      localStorage.setItem("service_env_filter", selectedServiceEnv);
      load();
    });

    document.getElementById("serviceSearchInput").addEventListener("input", (event) => {
      serviceSearchTerm = String(event.target.value || "");
      localStorage.setItem("service_search_term", serviceSearchTerm);
      load();
    });

    document.getElementById("dockerSearchInput").addEventListener("input", (event) => {
      dockerSearchTerm = String(event.target.value || "");
      localStorage.setItem("docker_search_term", dockerSearchTerm);
      load();
    });

    document.addEventListener("click", (event) => {
      const btn = event.target.closest("[data-pw-toggle]");
      if (!btn) return;
      const targetId = btn.getAttribute("data-pw-toggle");
      const input = document.getElementById(targetId || "");
      if (!input) return;
      const isPassword = input.type === "password";
      input.type = isPassword ? "text" : "password";
      const iconMode = btn.getAttribute("data-pw-icon") === "true";
      if (iconMode) {
        const visible = !isPassword;
        btn.innerHTML = passwordToggleIcon(visible);
        btn.setAttribute("aria-label", visible ? "Ocultar senha" : "Mostrar senha");
        btn.setAttribute("title", visible ? "Ocultar senha" : "Mostrar senha");
      } else {
        btn.textContent = isPassword ? "Ocultar" : "Mostrar";
      }
    });

    const allowedEnvFilters = new Set(["all", "production", "staging"]);
    if (!allowedEnvFilters.has(selectedServiceEnv)) {
      selectedServiceEnv = "production";
    }
    document.getElementById("serviceEnvFilter").value = selectedServiceEnv;
    document.getElementById("serviceSearchInput").value = serviceSearchTerm;
    document.getElementById("dockerSearchInput").value = dockerSearchTerm;

    async function bootstrapSession() {
      try {
        const response = await apiFetch("/api/auth/me");
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Sessão inválida");
        }
        setSession(data.user?.username || "", data.user?.role || "viewer");
        showDashboardView();
        await load();
      } catch (_) {
        setSession("", "");
        showLoginView("Sessão expirada. Faça login novamente.", true);
      }
    }

    bootstrapSession();
    window.addEventListener("resize", renderRamChart);
    window.addEventListener("resize", renderTrafficChart);
  </script>
</body>
</html>
