<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infra Dashboard - VPS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #edf4ff;
      --card: #f8fbff;
      --ink: #152a44;
      --muted: #5a7596;
      --accent: #1f6fca;
      --ok: #2f7f5d;
      --warn: #b58a2f;
      --bad: #aa4e4e;
      --line: #d7e6f7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, #f3f8ff, var(--bg));
      color: var(--ink);
      padding: 34px 28px;
      min-height: 100vh;
    }

    .auth-shell {
      max-width: 420px;
      margin: 8vh auto 0;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 16px 30px rgba(0,0,0,0.08);
      padding: 18px;
    }

    .auth-shell h2 {
      margin: 0 0 8px;
      font-size: 24px;
    }

    .auth-msg {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 12px;
      min-height: 18px;
    }

    .auth-label {
      display: block;
      font-weight: 600;
      margin: 10px 0 6px;
      font-size: 14px;
    }

    .auth-input {
      width: 100%;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--ink);
    }

    .auth-btn {
      margin-top: 14px;
      width: 100%;
      border: 1px solid #0f4f99;
      background: #1f6fca;
      color: #fff;
      border-radius: 10px;
      padding: 11px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .session-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .session-user {
      display: inline-flex;
      align-items: center;
      min-height: 38px;
      color: var(--muted);
      font-size: 13px;
    }

    .logout-btn {
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      padding: 0 14px;
      cursor: pointer;
    }

    .gear-btn {
      width: 38px;
      height: 38px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
    }

    .users-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 42, 68, 0.42);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 40;
    }

    .users-modal.open {
      display: flex;
    }

    .users-panel {
      width: min(980px, 100%);
      max-height: calc(100vh - 48px);
      overflow: auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15);
      padding: 14px;
    }

    .users-panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .users-panel-head h2 {
      margin: 0;
      font-size: 24px;
    }

    .users-toolbar {
      display: flex;
      gap: 8px;
      align-items: end;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .users-field {
      display: grid;
      gap: 4px;
      min-width: 180px;
      flex: 1;
    }

    .users-field label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    .users-field input,
    .users-field select {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background: #fff;
      color: var(--ink);
    }

    .primary-btn {
      border: 1px solid #0f4f99;
      background: #1f6fca;
      color: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }

    .mini-btn {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .top-stack {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 12px;
      width: 100%;	
    }

    .top-stack > .hero,
    .top-stack > .card {
      grid-column: 1 / -1;
      width: 100%;
      max-width: none;
      margin: 0;
      justify-self: stretch;
     }

    .hero {
      border-radius: 18px;
      padding: 18px;
      background:
        linear-gradient(135deg, rgba(13,79,153,0.18), rgba(31,111,202,0.16)),
        url("/img/hero-infra.png") center center/cover no-repeat;
      color: #fff;
      box-shadow: 0 14px 30px rgba(0,0,0,0.12);
      min-height: 260px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
    }

    .hero h1 {
      margin: 0 0 6px;
      font-size: 68px;
      line-height: 1.02;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    .hero p {
      margin: 0;
      opacity: 0.98;
      font-size: 30px;
      line-height: 1.15;
      max-width: 900px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }

    .card {
      grid-column: span 6;
      border-radius: 16px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      min-width: 0;
    }

    .card.full { grid-column: span 12; }

    .card h2 {
      margin: 0 0 10px;
      font-size: 28px;
    }

    .meta {
      color: var(--muted);
      font-size: 14px;
    }

    .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .ok { background: var(--ok); }
    .warn { background: var(--warn); }
    .bad { background: var(--bad); }

    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 14px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border-bottom: 1px solid var(--line);
      text-align: left;
      padding: 8px 10px;
      vertical-align: middle;
    }

    th { background: #e7f0fb; }

    #dockerRows td:nth-child(1),
    #dockerRows td:nth-child(2),
    #dockerRows td:nth-child(3),
    #dockerRows td:nth-child(5) {
      white-space: nowrap;
    }

    #dockerRows td:nth-child(4) {
      white-space: normal;
      word-break: break-word;
    }

    .st {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .st-run {
      background: #d9ebff;
      color: #0f4f99;
      border: 1px solid #9dc5f2;
    }

    .st-stop {
      background: #ffe0e0;
      color: #9b2c2c;
      border: 1px solid #f0b3b3;
    }

    .services {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }

    .service-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .service-info {
      display: grid;
      gap: 4px;
      min-width: 0;
    }

    .service-detail {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    .footer {
      color: var(--muted);
      font-size: 12px;
      text-align: right;
    }

    .sys-top {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }

    .sys-uptime {
      color: #1f3f67;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .sys-specs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      align-items: stretch;
    }

    .spec {
      position: relative;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--line);
      padding: 12px;
      min-width: 0;
      overflow: hidden;
    }

    .spec::after {
      position: absolute;
      right: 10px;
      bottom: 6px;
      font-size: 52px;
      line-height: 1;
      font-weight: 800;
      opacity: 0.14;
      pointer-events: none;
    }

    .sys-specs .spec:nth-child(1) {
      background: linear-gradient(145deg, #fff6df, #ffe8b8);
      border-color: #f2cf80;
      color: #3d2a00;
    }

    .sys-specs .spec:nth-child(1)::after {
      content: "CPU";
      color: #7b4f00;
    }

    .sys-specs .spec:nth-child(2) {
      background: linear-gradient(145deg, #e6f6ff, #cfeeff);
      border-color: #98cde8;
      color: #032f45;
    }

    .sys-specs .spec:nth-child(2)::after {
      content: "RAM";
      color: #0a4f73;
    }

    .sys-specs .spec:nth-child(3) {
      background: linear-gradient(145deg, #eafceb, #d4f5d7);
      border-color: #9fdfab;
      color: #093516;
    }

    .sys-specs .spec:nth-child(3)::after {
      content: "SSD";
      color: #2b6f3a;
    }

    .spec-label {
      color: currentColor;
      opacity: 0.85;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .spec-value {
      font-size: 24px;
      font-weight: 800;
      line-height: 1.15;
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;    
    }

    @media (max-width: 900px) {
      .hero { min-height: 180px; padding: 24px 18px; }
      .hero h1 { font-size: 44px; }
      .hero p { font-size: 24px; }

      .card, .card.full { grid-column: span 12; }
      .sys-specs { grid-template-columns: 1fr; }
      .services { grid-template-columns: 1fr; }
    }

/* Alinhar largura do banner com o card Sistema */
.page .top-stack {
  width: 100% !important;
  grid-template-columns: repeat(12, minmax(0, 1fr)) !important;
}

.page .top-stack > .hero {
  width: 100% !important;
  max-width: none !important;
  min-width: 0 !important;
  grid-column: 1 / -1 !important;
  justify-self: stretch !important;
  margin: 0 !important;
}

  </style>
</head>
<body>
  <section class="auth-shell" id="loginView">
    <h2>Acesso ao Monitor</h2>
    <div class="auth-msg" id="loginMsg">Informe suas credenciais para continuar.</div>
    <form id="loginForm">
      <label class="auth-label" for="usernameInput">Usuário</label>
      <input class="auth-input" id="usernameInput" name="username" autocomplete="username" required />
      <label class="auth-label" for="passwordInput">Senha</label>
      <input class="auth-input" id="passwordInput" name="password" type="password" autocomplete="current-password" required />
      <button class="auth-btn" id="loginBtn" type="submit">Entrar</button>
    </form>
  </section>

  <div class="page" id="dashboardView" style="display:none;">
    <div class="session-bar">
      <span class="session-user" id="sessionUser"></span>
      <button class="gear-btn" id="openUsersModalBtn" type="button" title="Configuração de usuários" style="display:none;">&#9881;</button>
      <button class="logout-btn" id="logoutBtn" type="button">Sair</button>
    </div>
    <section class="top-stack">
      <section class="hero">
        <h1>Monitor VPS</h1>
        <p>Monitoramento do Servidor - VPS</p>
      </section>

      <article class="card full">
        <h2>Sistema</h2>
        <div class="sys-top" id="sysMeta">Carregando...</div>
        <div class="sys-uptime" id="sysUptime">Tempo ativo: --</div>
        <div class="sys-specs">
          <div class="spec">
            <div class="spec-label">CPU</div>
            <div class="spec-value" id="cpuSpec">--</div>
          </div>
          <div class="spec">
            <div class="spec-label">RAM</div>
            <div class="spec-value" id="ramSpec">--</div>
          </div>
          <div class="spec">
            <div class="spec-label">Armazenamento</div>
            <div class="spec-value" id="diskSpec">--</div>
          </div>
        </div>
      </article>
    </section>

    <div class="grid">
      <article class="card full">
        <h2>Serviços</h2>
        <div class="services" id="services"></div>
      </article>

      <article class="card full">
        <h2>Containers Docker</h2>
        <div class="meta" id="dockerMeta">Carregando...</div>
        <div style="margin-top:10px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Status</th>
                <th>Imagem</th>
                <th>Ports</th>
                <th>Rede</th>
              </tr>
            </thead>
            <tbody id="dockerRows"></tbody>
          </table>
        </div>
      </article>
    </div>

    <div class="footer" id="updatedAt">Atualizando...</div>
  </div>

  <section class="users-modal" id="usersModal" aria-hidden="true">
    <article class="users-panel">
      <div class="users-panel-head">
        <h2>Usuários</h2>
        <div style="display:flex; gap:8px;">
          <button class="logout-btn" id="changePasswordBtn" type="button">Trocar senha</button>
          <button class="logout-btn" id="closeUsersModalBtn" type="button">Fechar</button>
        </div>
      </div>
      <div class="users-toolbar">
          <div class="users-field">
            <label for="newUsername">Usuário</label>
            <input id="newUsername" placeholder="ex: suporte.portaleco" />
          </div>
          <div class="users-field">
            <label for="newPassword">Senha inicial</label>
            <input id="newPassword" type="password" placeholder="mínimo 8 caracteres" />
          </div>
          <div class="users-field" style="max-width:160px;">
            <label for="newRole">Perfil</label>
            <select id="newRole">
              <option value="viewer">viewer</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <button class="primary-btn" id="createUserBtn" type="button">Criar usuário</button>
        <div class="meta" id="usersMeta">Carregando usuários...</div>
        <div style="margin-top:10px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Usuário</th>
                <th>Perfil</th>
                <th>Status</th>
                <th>Atualizado</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody id="usersRows"></tbody>
          </table>
        </div>
      </div>
    </article>
  </section>

  <script>
    const TOKEN_KEY = "portaleco_vps_monitor_token";
    const USER_KEY = "portaleco_vps_monitor_user";
    const USER_ROLE_KEY = "portaleco_vps_monitor_role";
    let pollHandle = null;

    const fmtBytes = (n) => {
      const num = Number(n || 0);
      if (num <= 0) return "0 B";
      const u = ["B","KB","MB","GB","TB"];
      let i = 0, v = num;
      while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; }
      return v.toFixed(i === 0 ? 0 : 2) + " " + u[i];
    };

    const fmtNum = (n) => Number(n || 0).toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

    const toGb = (n) => Number(n || 0) / (1024 ** 3);
    const toMb = (n) => Number(n || 0) / (1024 ** 2);
    const fmtUptime = (seconds) => {
      let total = Math.max(0, Number(seconds || 0));
      const days = Math.floor(total / 86400);
      total -= days * 86400;
      const hours = Math.floor(total / 3600);
      total -= hours * 3600;
      const minutes = Math.floor(total / 60);
      const parts = [];
      if (days > 0) parts.push(days + "d");
      if (hours > 0 || days > 0) parts.push(hours + "h");
      parts.push(minutes + "min");
      return parts.join(" ");
    };
    const fmtDateTime = (date) => date.toLocaleString("pt-BR");

    const dot = (ok) =>
      '<span class="dot ' + (ok ? 'ok' : 'bad') + '"></span>' + (ok ? "Online" : "Offline");

    const getToken = () => localStorage.getItem(TOKEN_KEY) || "";
    const getUser = () => localStorage.getItem(USER_KEY) || "";
    const getRole = () => localStorage.getItem(USER_ROLE_KEY) || "";
    const isAdmin = () => getRole() === "admin";
    const usersModalEl = document.getElementById("usersModal");

    const setSession = (token, username, role) => {
      if (token) localStorage.setItem(TOKEN_KEY, token);
      else localStorage.removeItem(TOKEN_KEY);

      if (username) localStorage.setItem(USER_KEY, username);
      else localStorage.removeItem(USER_KEY);

      if (role) localStorage.setItem(USER_ROLE_KEY, role);
      else localStorage.removeItem(USER_ROLE_KEY);
    };

    const setLoginMessage = (message, isError = false) => {
      const el = document.getElementById("loginMsg");
      el.textContent = message;
      el.style.color = isError ? "#9b2c2c" : "var(--muted)";
    };

    const showLoginView = (message, isError = false) => {
      document.getElementById("loginView").style.display = "block";
      document.getElementById("dashboardView").style.display = "none";
      setLoginMessage(message, isError);
      if (pollHandle) {
        clearInterval(pollHandle);
        pollHandle = null;
      }
    };

    const showDashboardView = () => {
      document.getElementById("loginView").style.display = "none";
      document.getElementById("dashboardView").style.display = "grid";
      const user = getUser();
      const role = getRole();
      document.getElementById("sessionUser").textContent =
        user ? ("Usuário: " + user + (role ? " (" + role + ")" : "")) : "";
      document.getElementById("openUsersModalBtn").style.display = isAdmin() ? "inline-flex" : "none";
      closeUsersModal();
      if (!pollHandle) {
        pollHandle = setInterval(load, 10000);
      }
    };

    async function apiFetch(path, options = {}) {
      const token = getToken();
      const headers = new Headers(options.headers || {});
      if (token) {
        headers.set("Authorization", "Bearer " + token);
      }

      const response = await fetch(path, { ...options, headers });
      if (response.status === 401) {
        const err = new Error("Sessão expirada. Faça login novamente.");
        err.authError = true;
        throw err;
      }

      return response;
    }

    async function parseJsonResponse(response) {
      const bodyText = await response.text();
      if (!bodyText) return {};
      try {
        return JSON.parse(bodyText);
      } catch (_) {
        const preview = bodyText.replace(/\s+/g, " ").trim().slice(0, 140);
        throw new Error(
          "Resposta invalida da API (HTTP " + response.status + ")" +
          (preview ? ": " + preview : "")
        );
      }
    }

    async function load() {
      try {
        const [systemRes, dockerRes, servicesRes, firebirdRes, tunnelRes] = await Promise.all([
          apiFetch("/api/system"),
          apiFetch("/api/docker"),
          apiFetch("/api/services"),
          apiFetch("/api/firebird"),
          apiFetch("/api/tunnel")
        ]);

        const [system, docker, services, firebird, tunnel] = await Promise.all([
          parseJsonResponse(systemRes),
          parseJsonResponse(dockerRes),
          parseJsonResponse(servicesRes),
          parseJsonResponse(firebirdRes),
          parseJsonResponse(tunnelRes)
        ]);

        document.getElementById("cpuSpec").textContent = String(system.cpu_cores || 4);
        document.getElementById("ramSpec").textContent =
          `${fmtNum(toGb(system.memory?.total))} GB / ${fmtNum(toMb(system.memory?.used))} MB`;
        document.getElementById("diskSpec").textContent =
          `${fmtNum(toGb(system.disk?.total))} GB / ${fmtNum(toGb(system.disk?.used))} GB`;

        document.getElementById("sysMeta").textContent =
          "Host: " + (system.hostname || "-") +
          " | RAM: " + fmtBytes(system.memory?.used) + " / " + fmtBytes(system.memory?.total) +
          " | Disco: " + fmtBytes(system.disk?.used) + " / " + fmtBytes(system.disk?.total);
        const startedAt = new Date(Date.now() - (Number(system.uptime_seconds || 0) * 1000));
        document.getElementById("sysUptime").textContent =
          "Tempo ativo do servidor: " + fmtUptime(system.uptime_seconds) +
          " | Iniciado em: " + fmtDateTime(startedAt);

        const serviceCards = [
          {
            name: "chalana-api",
            online: Boolean(services.services && services.services["chalana-api"]),
            detail: "API principal"
          },
          {
            name: "firebird25",
            online: Boolean(services.services && services.services["firebird25"]),
            detail: "Banco Firebird"
          },
          {
            name: "nginx-proxy-manager",
            online: Boolean(services.services && services.services["nginx-proxy-manager"]),
            detail: "Proxy reverso"
          },
          {
            name: "cloudflared",
            online: Boolean(services.services && services.services["cloudflared"]),
            detail: "Tunnel Cloudflare"
          },
          {
            name: "tunnel",
            online: Boolean(tunnel.running),
            detail: "Registrado: " + (tunnel.registered ? "Sim" : "Não")
          },
          {
            name: "firebird monitor",
            online: Boolean(firebird.ok),
            detail: "Versão: " + (firebird.version || "-") + " | Resp: " + (firebird.response_ms ?? "-") + " ms"
          }
        ];
        const servicesEl = document.getElementById("services");
        servicesEl.innerHTML = serviceCards.map((item) => {
          return '<div class="service-item">' +
            '<div class="service-info">' +
              '<strong>' + item.name + '</strong>' +
              '<div class="service-detail">' + item.detail + '</div>' +
            '</div>' +
            '<span>' + dot(item.online) + '</span>' +
          '</div>';
        }).join("");

        document.getElementById("dockerMeta").textContent =
          "Total: " + (docker.total || 0) + " | Running: " + (docker.running || 0);

        const rows = (docker.containers || []).map((c) =>
          "<tr>" +
            "<td>" + (c.name || "") + "</td>" +
            "<td>" + (c.running
              ? "<span class='st st-run'>Iniciado</span>"
              : "<span class='st st-stop'>Parado</span>") + "</td>" +
            "<td>" + (c.image || "") + "</td>" +
            "<td>" + (c.ports || "") + "</td>" +
            "<td>" + (c.network || "") + "</td>" +
          "</tr>"
        ).join("");

        document.getElementById("dockerRows").innerHTML =
          rows || "<tr><td colspan='5'>Sem dados</td></tr>";

        document.getElementById("updatedAt").textContent =
          "Atualizado em: " + new Date().toLocaleString("pt-BR");

        if (isAdmin() && usersModalEl.classList.contains("open")) {
          await loadUsers();
        }
      } catch (e) {
        if (e.authError) {
          setSession("", "", "");
          showLoginView(e.message, true);
          return;
        }
        document.getElementById("updatedAt").textContent = "Erro ao atualizar: " + e.message;
      }
    }

    async function loadUsers() {
      if (!isAdmin()) return;
      try {
        const response = await apiFetch("/api/auth/users");
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao carregar usuários");
        }

        const users = Array.isArray(data.users) ? data.users : [];
        document.getElementById("usersMeta").textContent = "Total: " + users.length;
        document.getElementById("usersRows").innerHTML = users.map((u) => {
          const actionLabel = u.active ? "Desativar" : "Ativar";
          return "<tr>" +
            "<td>" + (u.username || "-") + "</td>" +
            "<td>" + (u.role || "-") + "</td>" +
            "<td>" + (u.active ? "<span class='st st-run'>Ativo</span>" : "<span class='st st-stop'>Inativo</span>") + "</td>" +
            "<td>" + (u.updated_at || "-") + "</td>" +
            "<td><button class='mini-btn' data-user-toggle='" + (u.username || "") + "' data-user-active='" + (u.active ? "1" : "0") + "'>" + actionLabel + "</button></td>" +
          "</tr>";
        }).join("") || "<tr><td colspan='5'>Sem usuários</td></tr>";
      } catch (error) {
        document.getElementById("usersMeta").textContent = "Erro ao carregar usuários: " + error.message;
      }
    }

    document.getElementById("loginForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const username = document.getElementById("usernameInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      const button = document.getElementById("loginBtn");
      button.disabled = true;
      setLoginMessage("Autenticando...");

      try {
        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await parseJsonResponse(response);

        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha de autenticação");
        }

        if (data.auth_enabled === false) {
          setSession("", username || "local", "admin");
          showDashboardView();
          await load();
          return;
        }

        if (!data.token) {
          throw new Error("Token não recebido no login.");
        }

        setSession(data.token, data.user?.username || username, data.user?.role || "viewer");
        showDashboardView();
        await load();
      } catch (error) {
        setLoginMessage(error.message, true);
      } finally {
        button.disabled = false;
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      setSession("", "", "");
      showLoginView("Sessão encerrada.");
    });

    document.getElementById("changePasswordBtn").addEventListener("click", async () => {
      const currentPassword = window.prompt("Informe sua senha atual:");
      if (currentPassword === null) return;
      const newPassword = window.prompt("Informe a nova senha (mínimo 8 caracteres):");
      if (newPassword === null) return;
      const confirmPassword = window.prompt("Confirme a nova senha:");
      if (confirmPassword === null) return;

      if (newPassword.length < 8) {
        window.alert("A nova senha precisa ter no mínimo 8 caracteres.");
        return;
      }
      if (newPassword !== confirmPassword) {
        window.alert("A confirmação da senha não confere.");
        return;
      }

      try {
        const response = await apiFetch("/api/auth/change-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
          })
        });
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao alterar senha.");
        }
        window.alert("Senha alterada com sucesso.");
      } catch (error) {
        window.alert(error.message || "Falha ao alterar senha.");
      }
    });

    const openUsersModal = async () => {
      if (!isAdmin()) return;
      usersModalEl.classList.add("open");
      usersModalEl.setAttribute("aria-hidden", "false");
      await loadUsers();
    };

    const closeUsersModal = () => {
      usersModalEl.classList.remove("open");
      usersModalEl.setAttribute("aria-hidden", "true");
    };

    document.getElementById("openUsersModalBtn").addEventListener("click", () => {
      openUsersModal();
    });

    document.getElementById("closeUsersModalBtn").addEventListener("click", () => {
      closeUsersModal();
    });

    usersModalEl.addEventListener("click", (event) => {
      if (event.target === usersModalEl) {
        closeUsersModal();
      }
    });

    document.getElementById("createUserBtn").addEventListener("click", async () => {
      const username = document.getElementById("newUsername").value.trim();
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;

      if (!username || !password) {
        window.alert("Preencha usuário e senha.");
        return;
      }
      if (password.length < 8) {
        window.alert("A senha precisa ter no mínimo 8 caracteres.");
        return;
      }

      try {
        const response = await apiFetch("/api/auth/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role })
        });
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao criar usuário");
        }
        document.getElementById("newUsername").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("newRole").value = "viewer";
        await loadUsers();
      } catch (error) {
        window.alert(error.message || "Falha ao criar usuário");
      }
    });

    document.getElementById("usersRows").addEventListener("click", async (event) => {
      const btn = event.target.closest("button[data-user-toggle]");
      if (!btn) return;
      const username = btn.getAttribute("data-user-toggle");
      const currentlyActive = btn.getAttribute("data-user-active") === "1";
      const nextActive = !currentlyActive;

      try {
        const response = await apiFetch("/api/auth/users/" + encodeURIComponent(username) + "/active", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ active: nextActive })
        });
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Falha ao atualizar usuário");
        }
        await loadUsers();
      } catch (error) {
        window.alert(error.message || "Falha ao atualizar usuário");
      }
    });

    async function bootstrapSession() {
      if (!getToken()) {
        showLoginView("Informe suas credenciais para continuar.");
        return;
      }

      try {
        const response = await apiFetch("/api/auth/me");
        const data = await parseJsonResponse(response);
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Sessão inválida");
        }
        setSession(getToken(), data.user?.username || getUser(), data.user?.role || getRole() || "viewer");
        showDashboardView();
        await load();
      } catch (_) {
        setSession("", "", "");
        showLoginView("Sessão expirada. Faça login novamente.", true);
      }
    }

    bootstrapSession();
  </script>
</body>
</html>
